name: Deploy RabbitMQ via ArgoCD (Test)

on:
  workflow_dispatch:
    inputs:
      cluster:
        description: "ArgoCD cluster name"
        required: true
        type: choice
        options:
          - non-prod
          - production

      namespace:
        description: "Kubernetes namespace"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate namespace for selected cluster
        run: |
          CLUSTER="${{ github.event.inputs.cluster }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"

          NON_PROD_NAMESPACES=("dev" "qa" "staging")
          PROD_NAMESPACES=("prod" "rabbitmq-prod")

          if [[ "$CLUSTER" == "non-prod" ]]; then
            if [[ ! " ${NON_PROD_NAMESPACES[@]} " =~ " ${NAMESPACE} " ]]; then
              echo "‚ùå Namespace '$NAMESPACE' is NOT allowed for non-prod"
              exit 1
            fi
          fi

          if [[ "$CLUSTER" == "production" ]]; then
            if [[ ! " ${PROD_NAMESPACES[@]} " =~ " ${NAMESPACE} " ]]; then
              echo "‚ùå Namespace '$NAMESPACE' is NOT allowed for production"
              exit 1
            fi
          fi

          echo "‚úÖ Namespace validation passed"

      - name: Deploy RabbitMQ via ArgoCD
        run: |
          echo "üöÄ Deploying RabbitMQ"
          echo "Cluster: ${{ github.event.inputs.cluster }}"
          echo "Namespace: ${{ github.event.inputs.namespace }}"

          # Example argocd command
          # argocd app create rabbitmq \
          #   --dest-server https://kubernetes.default.svc \
          #   --dest-namespace ${{ github.event.inputs.namespace }} \
          #   --repo https://github.com/org/repo.git \
          #   --path rabbitmq \
          #   --revision main

