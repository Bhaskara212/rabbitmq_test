name: Deploy RabbitMQ via ArgoCD (Test)

on:
  workflow_dispatch:
    inputs:
      cluster:
        description: "ArgoCD cluster name"
        required: true
        type: choice
        options:
          - non-prod
          - production

      namespace:
        description: "Namespace (see available namespaces in summary)"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Display available namespaces (Workspace)
        run: |
          CLUSTER="${{ github.event.inputs.cluster }}"

          if [[ "$CLUSTER" == "non-prod" ]]; then
            NAMESPACES="${{ vars.NON_PROD_NAMESPACES }}"
          else
            NAMESPACES="${{ vars.PROD_NAMESPACES }}"
          fi

          echo "### ðŸ“¦ Available Namespaces for **$CLUSTER**" >> $GITHUB_STEP_SUMMARY
          for ns in $NAMESPACES; do
            echo "- \`$ns\`" >> $GITHUB_STEP_SUMMARY
          done

      - name: Resolve and validate namespace
        run: |
          CLUSTER="${{ github.event.inputs.cluster }}"
          INPUT_NAMESPACE="${{ github.event.inputs.namespace }}"

          if [[ "$CLUSTER" == "non-prod" ]]; then
            ALLOWED="${{ vars.NON_PROD_NAMESPACES }}"
          else
            ALLOWED="${{ vars.PROD_NAMESPACES }}"
          fi

          if [[ ! " $ALLOWED " =~ " $INPUT_NAMESPACE " ]]; then
            echo "âŒ Invalid namespace: $INPUT_NAMESPACE"
            exit 1
          fi

          echo "DEPLOY_NAMESPACE=$INPUT_NAMESPACE" >> $GITHUB_ENV

          echo "### âœ… Selected Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- Cluster: **$CLUSTER**" >> $GITHUB_STEP_SUMMARY
          echo "- Namespace: **$INPUT_NAMESPACE**" >> $GITHUB_STEP_SUMMARY

      - name: Deploy RabbitMQ via ArgoCD
        run: |
          echo "ðŸš€ Deploying RabbitMQ to $DEPLOY_NAMESPACE"
