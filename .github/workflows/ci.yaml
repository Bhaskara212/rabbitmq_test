name: Deploy RabbitMQ via ArgoCD (Test)

on:
  workflow_dispatch:
    inputs:
      cluster:
        description: "ArgoCD cluster name"
        required: true
        type: choice
        options:
          - non-prod
          - production

      namespace:
        description: "Namespace (must belong to selected cluster)"
        required: true
        type: string

env:
  NON_PROD_NAMESPACES: "uat qa staging"
  PROD_NAMESPACES: "production"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve and validate namespace (Driven variable)
        run: |
          CLUSTER="${{ github.event.inputs.cluster }}"
          NAMESPACE="${{ github.event.inputs.namespace }}"

          if [[ "$CLUSTER" == "non-prod" ]]; then
            ALLOWED_NAMESPACES="$NON_PROD_NAMESPACES"
          elif [[ "$CLUSTER" == "production" ]]; then
            ALLOWED_NAMESPACES="$PROD_NAMESPACES"
          else
            echo "âŒ Invalid cluster"
            exit 1
          fi

          if [[ ! " $ALLOWED_NAMESPACES " =~ " $NAMESPACE " ]]; then
            echo "âŒ Namespace '$NAMESPACE' is not allowed for cluster '$CLUSTER'"
            echo "Allowed namespaces: $ALLOWED_NAMESPACES"
            exit 1
          fi

          # Driven namespace variable (available everywhere)
          echo "DEPLOY_NAMESPACE=$NAMESPACE" >> $GITHUB_ENV

          echo "âœ… Namespace resolved: $DEPLOY_NAMESPACE"

      - name: Deploy RabbitMQ via ArgoCD
        run: |
          echo "ðŸš€ Deploying RabbitMQ"
          echo "Cluster: ${{ github.event.inputs.cluster }}"
          echo "Namespace: $DEPLOY_NAMESPACE"

          # Example:
          # argocd app create rabbitmq \
          #   --dest-namespace $DEPLOY_NAMESPACE
